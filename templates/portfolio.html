{% extends "base.html" %}

{% block content %}
<section class="dashboard-layout-12">
    <!-- 1. Top Stats Row (Span 12) -->
    <div class="col-span-12 stats-grid-4">
        <!-- Investment -->
        <div class="card stat-card">
            <div class="stat-label">Total Investment</div>
            <div id="totalInvestment" class="stat-value">$0.00</div>
        </div>
        <!-- Value -->
        <div class="card stat-card">
            <div class="stat-label">Current Value</div>
            <div id="currentValue" class="stat-value">$0.00</div>
        </div>
        <!-- P/L -->
        <div class="card stat-card">
            <div class="stat-label">Total Profit/Loss</div>
            <div id="totalPL" class="stat-value">$0.00</div>
        </div>
        <!-- Health Score -->
        <div class="card health-score-card">
            <div>
                <h3 style="font-size: 1rem; color: var(--text-secondary); margin-bottom: 5px;">Health Score</h3>
                <p style="font-size: 0.75rem; color: var(--text-secondary); max-width: 150px;">
                    DSA-based metric (Profit, Risk, Diversity)
                </p>
            </div>
            <div class="health-score-display">
                <div id="healthScore" class="health-score-number" style="font-size: 3rem;">0</div>
            </div>
        </div>
    </div>

    <!-- 2. Main Content Area (Span 9) -->
    <div class="col-span-9 main-content-area">
        <!-- Charts Row -->
        <div class="chart-grid-2" style="grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
            <!-- Diversity Chart -->
            <div class="card" style="min-height: 380px; display: flex; flex-direction: column;">
                <div class="card-header">
                    <h3>Platform Diversity</h3>
                    <p style="font-size: 0.8em; color: var(--text-secondary);">Set-based O(1) tracking</p>
                </div>
                <div style="flex:1; position: relative;">
                    <canvas id="platformChart"></canvas>
                </div>
            </div>
            <!-- Sector Chart (New) -->
            <div class="card" style="min-height: 380px; display: flex; flex-direction: column;">
                <div class="card-header">
                    <h3>Sector Allocation</h3>
                    <p style="font-size: 0.8em; color: var(--text-secondary);">Market Exposure</p>
                </div>
                <div style="flex:1; position: relative;">
                    <canvas id="sectorChart"></canvas>
                </div>
            </div>
            <!-- Risk Chart -->
            <div class="card" style="min-height: 380px; display: flex; flex-direction: column;">
                <div class="card-header">
                    <h3>Risk vs. Profit</h3>
                    <p style="font-size: 0.8em; color: var(--text-secondary);">Volatility Analysis</p>
                </div>
                <div style="flex:1; position: relative;">
                    <canvas id="riskScatterChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Holdings Table -->
        <div class="card">
            <div class="card-header">
                <h3>Full Portfolio Holdings</h3>
                <p style="font-size: 0.8em; color: var(--text-secondary);">Click on a row for detailed analysis</p>
            </div>
            <div class="table-container">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr>
                            <th style="cursor: pointer;" onclick="fetchHoldings('symbol')">Symbol ↕</th>
                            <th>Platform</th>
                            <th>Qty</th>
                            <th class="hide-mobile">Buy Price</th>
                            <th>Current</th>
                            <th style="cursor: pointer;" onclick="fetchHoldings('profit')">P/L ↕</th>
                            <th class="hide-mobile" style="cursor: pointer;" onclick="fetchHoldings('score')">Score ↕
                            </th>
                        </tr>
                    </thead>
                    <tbody id="holdingsTableBody">
                        <!-- Rendered by JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 3. Sidebar (Span 3) -->
    <div class="col-span-3 sticky-sidebar">
        <!-- Add Form -->
        <div class="card portfolio-form-card">
            <div class="card-header" style="border:none; margin-bottom: 15px; padding-bottom: 0;">
                <h2 style="font-size: 1.2rem; color: var(--accent);">+ Add Holding</h2>
            </div>
            <form id="portfolioForm" onsubmit="addToPortfolio(event)"
                style="display: flex; flex-direction: column; gap: 12px;">
                <div class="portfolio-input-field">
                    <input type="text" name="symbol" placeholder="Symbol (e.g. AAPL)" required>
                </div>
                <div style="display: flex; gap: 10px;">
                    <div class="portfolio-input-field">
                        <input type="number" name="quantity" placeholder="Qty" required>
                    </div>
                    <div class="portfolio-input-field">
                        <input type="number" step="0.01" name="buy_price" placeholder="Price" required>
                    </div>
                </div>
                <div class="portfolio-input-field">
                    <select name="platform" required>
                        <option value="" disabled selected>Select Platform</option>
                        <option value="Zerodha">Zerodha</option>
                        <option value="Groww">Groww</option>
                        <option value="Upstox">Upstox</option>
                        <option value="AngelOne">AngelOne</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <button type="submit" class="btn-add-holding" style="width: 100%; margin-top: 5px;">
                    Add to Portfolio
                </button>
            </form>
        </div>

        <!-- Top K Leaders -->
        <div class="card" style="padding: 15px;">
            <div style="margin-bottom: 15px;">
                <h3 style="font-size: 1.1rem; margin-bottom: 10px;">Top Performers</h3>
                <div class="filter-btn-group" style="width: 100%; justify-content: space-between;">
                    <button class="filter-btn active" style="flex:1; padding: 6px;"
                        onclick="switchTopK(this, 'profit')">Profit</button>
                    <button class="filter-btn" style="flex:1; padding: 6px;"
                        onclick="switchTopK(this, 'risk')">Risk</button>
                    <button class="filter-btn" style="flex:1; padding: 6px;"
                        onclick="switchTopK(this, 'score')">Score</button>
                </div>
            </div>
            <div id="topKContainer" style="display: flex; flex-direction: column; gap: 10px;">
                <!-- Vertical List for Sidebar -->
            </div>
        </div>
    </div>
</section>

<!-- Analysis Modal -->
<div id="analysisModal" class="modal">
    <div class="modal-content"
        style="width: 700px; max-width: 90vw; background: rgba(15, 23, 42, 0.95); border: 1px solid var(--accent); position: relative;">
        <span class="close" onclick="closeAnalysisModal()"
            style="position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: var(--text-secondary);">&times;</span>
        <div id="modalContent" style="padding: 20px;">
            <!-- Populated by JS -->
        </div>
    </div>
</div>

<script>
    // Global Chart Instances
    let platformChartInstance = null;
    let sectorChartInstance = null;
    let scatterChartInstance = null;

    document.addEventListener('DOMContentLoaded', () => {
        refreshDashboard();
    });

    async function addToPortfolio(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());

        try {
            const res = await fetch('/api/portfolio/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await res.json();
            if (res.ok) {
                const btn = e.target.querySelector('button');
                const originalText = btn.innerHTML;
                btn.innerHTML = '✔ Added!';
                btn.style.background = 'var(--success)';

                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '';
                }, 2000);

                e.target.reset();
                refreshDashboard();
            } else {
                alert(result.error);
            }
        } catch (err) {
            console.error(err);
            alert("Failed to add stock");
        }
    }

    function refreshDashboard() {
        fetchStats();
        fetchCharts();
        fetchTopK('profit');
        fetchHoldings('profit');
    }

    async function fetchStats() {
        const res = await fetch('/api/portfolio/stats');
        const data = await res.json();

        document.getElementById('totalInvestment').textContent = `$${data.total_investment.toLocaleString(undefined, { minimumFractionDigits: 2 })}`;
        document.getElementById('currentValue').textContent = `$${data.current_value.toLocaleString(undefined, { minimumFractionDigits: 2 })}`;

        const plEl = document.getElementById('totalPL');
        const plText = `$${data.total_pl.toLocaleString(undefined, { minimumFractionDigits: 2 })} `;
        const pctSpan = `<span style="font-size: 0.6em; vertical-align: middle; padding: 2px 6px; border-radius: 4px; background: rgba(255,255,255,0.1);">${data.total_pl_pct.toFixed(2)}%</span>`;

        plEl.innerHTML = plText + pctSpan;
        plEl.style.color = data.total_pl >= 0 ? '#34d399' : '#fb7185';

        document.getElementById('healthScore').textContent = data.health_score;
    }

    async function fetchCharts() {
        // Platform Charts
        const resDist = await fetch('/api/portfolio/distribution');
        const distData = await resDist.json();

        const ctxPie = document.getElementById('platformChart').getContext('2d');
        if (platformChartInstance) platformChartInstance.destroy();

        platformChartInstance = new Chart(ctxPie, {
            type: 'doughnut',
            data: {
                labels: Object.keys(distData),
                datasets: [{
                    data: Object.values(distData),
                    backgroundColor: ['#6366f1', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'],
                    borderColor: 'rgba(30, 41, 59, 0.8)',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '65%',
                plugins: {
                    legend: { position: 'right', labels: { color: '#cbd5e1', font: { family: 'Inter', size: 10 }, boxWidth: 10 } }
                }
            }
        });

        // Sector Charts (New)
        const resSector = await fetch('/api/portfolio/sectors');
        const sectorData = await resSector.json();

        const ctxSector = document.getElementById('sectorChart').getContext('2d');
        if (sectorChartInstance) sectorChartInstance.destroy();

        sectorChartInstance = new Chart(ctxSector, {
            type: 'pie',
            data: {
                labels: Object.keys(sectorData),
                datasets: [{
                    data: Object.values(sectorData),
                    backgroundColor: ['#c084fc', '#34d399', '#fbbf24', '#f472b6', '#60a5fa', '#a78bfa'],
                    borderColor: 'rgba(30, 41, 59, 0.8)',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right', labels: { color: '#cbd5e1', font: { family: 'Inter', size: 10 }, boxWidth: 10 } }
                }
            }
        });


        // Scatter
        const resScat = await fetch('/api/portfolio/scatter');
        const scatData = await resScat.json();

        const ctxScat = document.getElementById('riskScatterChart').getContext('2d');
        if (scatterChartInstance) scatterChartInstance.destroy();

        scatterChartInstance = new Chart(ctxScat, {
            type: 'bubble',
            data: {
                datasets: [{
                    label: 'Holdings',
                    data: scatData,
                    backgroundColor: 'rgba(99, 102, 241, 0.6)',
                    borderColor: '#6366f1',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        title: { display: true, text: 'Risk', color: '#94a3b8' },
                        grid: { color: 'rgba(255,255,255,0.05)' },
                        ticks: { color: '#94a3b8' }
                    },
                    y: {
                        title: { display: true, text: 'Profit %', color: '#94a3b8' },
                        grid: { color: 'rgba(255,255,255,0.05)' },
                        ticks: { color: '#94a3b8' }
                    }
                },
                plugins: { legend: { display: false } }
            }
        });
    }

    function switchTopK(btn, criteria) {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        fetchTopK(criteria);
    }

    async function fetchTopK(criteria) {
        const res = await fetch(`/api/portfolio/top-k?k=3&type=${criteria}`);
        const data = await res.json();

        const container = document.getElementById('topKContainer');
        container.innerHTML = '';

        data.forEach((item, index) => {
            const card = document.createElement('div');
            // Mini Card Style for Sidebar
            card.style.cssText = `
                display: flex; 
                justify-content: space-between; 
                align-items: center; 
                padding: 12px; 
                background: rgba(255,255,255,0.03); 
                border-radius: 8px; 
                border: 1px solid var(--border);
            `;

            let val = '';
            let valColor = '';
            if (criteria === 'profit') {
                val = `${item.profit_loss_pct.toFixed(2)}%`;
                valColor = item.profit_loss >= 0 ? 'var(--success)' : 'var(--danger)';
            } else if (criteria === 'risk') {
                val = item.volatility.toFixed(4);
                valColor = 'var(--warning)';
            } else {
                val = item.score.toFixed(2);
                valColor = 'var(--accent)';
            }

            card.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="font-weight: bold; color: var(--text-secondary);">#${index + 1}</div>
                    <div>
                        <div style="font-weight: bold; color: var(--text-primary);">${item.symbol}</div>
                        <div style="font-size: 0.8em; color: var(--text-secondary);">$${item.current_price.toFixed(2)}</div>
                    </div>
                </div>
                <div style="font-weight: bold; color: ${valColor};">${val}</div>
            `;
            container.appendChild(card);
        });
    }

    async function fetchHoldings(sortKey) {
        const res = await fetch(`/api/portfolio/holdings?sort=${sortKey}&order=desc`);
        const data = await res.json();

        const tbody = document.getElementById('holdingsTableBody');
        tbody.innerHTML = '';

        data.forEach(item => {
            const tr = document.createElement('tr');
            tr.style.cursor = 'pointer';
            tr.onclick = () => openAnalysis(item);

            tr.innerHTML = `
                <td style="font-weight: bold; color: var(--accent);">${item.symbol}</td>
                <td><span style="background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 4px; font-size: 0.85em;">${item.platform}</span></td>
                <td>${item.quantity}</td>
                <td class="hide-mobile">$${item.buy_price.toFixed(2)}</td>
                <td>$${item.current_price.toFixed(2)}</td>
                <td style="color: ${item.profit_loss >= 0 ? '#34d399' : '#fb7185'}; font-weight: 500;">
                    $${item.profit_loss.toFixed(2)}
                </td>
                <td class="hide-mobile">
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <div style="flex:1; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden; width: 40px;">
                            <div style="height: 100%; width: ${Math.min(100, item.score)}%; background: var(--accent);"></div>
                        </div>
                        <span style="font-size: 0.85em;">${item.score}</span>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    async function openAnalysis(item) {
        // Show loading state first if needed, but it's fast
        const modal = document.getElementById('analysisModal');
        const content = document.getElementById('modalContent');
        modal.style.display = 'block';
        content.innerHTML = '<div style="text-align:center; padding: 20px;">Analyzing...</div>';

        try {
            // Fetch detailed trend
            const res = await fetch(`/api/trend/${item.symbol}`);
            const trendData = await res.json();

            const isProfit = item.profit_loss >= 0;
            const profitColor = isProfit ? '#34d399' : '#fb7185';

            // Simple analysis logic
            let verdict = "HOLD";
            if (trendData.trend === "UP" && isProfit) verdict = "STRONG BUY / HOLD";
            else if (trendData.trend === "DOWN" && !isProfit) verdict = "CONSIDER EXITING";
            else if (trendData.trend === "UP" && !isProfit) verdict = "RECOVERY LIKELY";
            else if (trendData.trend === "DOWN" && isProfit) verdict = "TAKE PROFIT";

            content.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 15px; margin-bottom: 20px;">
                    <h2 style="color: var(--accent); margin: 0;">${item.symbol} Analysis</h2>
                    <div style="font-size: 0.9em; color: var(--text-secondary);">${item.platform}</div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                    <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 5px;">Performance</div>
                        <div style="font-size: 2em; font-weight: bold; color: ${profitColor};">
                            ${item.profit_loss_pct.toFixed(2)}%
                        </div>
                        <div style="font-size: 1.1em; color: #e2e8f0; margin-top: 5px;">$${item.profit_loss.toFixed(2)} P/L</div>
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 8px; text-align: center;">
                         <div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 5px;">Trend (SMA-5)</div>
                         <div style="font-size: 2em; font-weight: bold; color: ${trendData.trend === 'UP' ? 'var(--success)' : 'var(--danger)'};">
                            ${trendData.trend}
                        </div>
                        <div style="font-size: 1.1em; color: #e2e8f0; margin-top: 5px;">SMA: $${trendData.sma.toFixed(2)}</div>
                    </div>
                </div>
                
                <div style="margin-bottom: 25px;">
                    <h3 style="font-size: 1.2em; color: white; margin-bottom: 15px;">Investment Thesis</h3>
                    <div style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 15px;">
                        <div style="margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
                            <span style="color: var(--accent);">➤</span> 
                            <strong style="width: 100px;">Sector:</strong> ${item.sector}
                        </div>
                        <div style="margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
                            <span style="color: var(--accent);">➤</span> 
                            <strong style="width: 100px;">Volatility:</strong> ${item.volatility}
                            <span style="font-size: 0.8em; color: ${item.volatility > 0.02 ? 'var(--warning)' : 'var(--success)'}">(${item.volatility > 0.02 ? 'High Risk' : 'Stable'})</span>
                        </div>
                        <div style="margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
                            <span style="color: var(--accent);">➤</span> 
                            <strong style="width: 100px;">DSA Score:</strong> ${item.score}/100
                        </div>
                    </div>
                </div>
                
                <div style="background: rgba(34, 211, 238, 0.1); border: 1px solid var(--accent); padding: 20px; border-radius: 8px; text-align: center; box-shadow: 0 4px 20px rgba(34, 211, 238, 0.15);">
                    <div style="font-size: 0.9em; color: var(--accent); text-transform: uppercase; letter-spacing: 2px;">Algorithmic Verdict</div>
                    <div style="font-size: 2.5em; font-weight: 900; margin-top: 10px; letter-spacing: -1px; background: linear-gradient(to right, #fff, #cbd5e1); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">${verdict}</div>
                </div>
            `;
        } catch (e) {
            console.error(e);
            content.innerHTML = '<div style="color: var(--danger)">Error loading analysis</div>';
        }
    }

    function closeAnalysisModal() {
        document.getElementById('analysisModal').style.display = 'none';
    }

    // Close modal when clicking outside
    window.onclick = function (event) {
        const modal = document.getElementById('analysisModal');
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }
</script>
{% endblock %}